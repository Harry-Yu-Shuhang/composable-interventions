#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_debug
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

echo "ðŸ”§ å¼€å§‹ DEBUG æ£€æŸ¥..." >> output.log
echo "ðŸ‘¤ ç”¨æˆ·: $(whoami)" >> output.log
echo "ðŸ“¡ ä¸»æœº: $(hostname)" >> output.log
echo "ðŸ“‚ å½“å‰è·¯å¾„: $(pwd)" >> output.log
echo "ðŸ—‚ å½“å‰ç›®å½•å†…å®¹:" >> output.log
ls -alh "$SLURM_SUBMIT_DIR" >> output.log

echo "ðŸ§ª æ£€æŸ¥ module å‘½ä»¤..." >> output.log
if [ -f /etc/profile.d/modules.sh ]; then
    echo "âœ… modules.sh å­˜åœ¨ï¼Œå°è¯• source" >> output.log
    source /etc/profile.d/modules.sh || echo "âš ï¸ source modules.sh å¤±è´¥" >> output.log
else
    echo "âŒ /etc/profile.d/modules.sh ä¸å­˜åœ¨" >> output.log
fi

echo "ðŸ“¦ å½“å‰åŠ è½½çš„ modules:" >> output.log
module list 2>> error.log >> output.log

echo "ðŸ“¥ å°è¯•åŠ è½½ CUDA æ¨¡å—..." >> output.log
module load cuda/11.8 && echo "âœ… æˆåŠŸåŠ è½½ cuda/11.8" >> output.log || echo "âŒ åŠ è½½ cuda/11.8 å¤±è´¥" >> output.log

echo "ðŸ” æ£€æŸ¥ nvcc è·¯å¾„:" >> output.log
which nvcc >> output.log 2>> error.log || echo "âŒ nvcc æœªæ‰¾åˆ°" >> output.log

echo "ðŸ“Œ å°è¯•æŸ¥æ‰¾ nvcc çœŸå®žè·¯å¾„:" >> output.log
find /usr/local -name nvcc 2>/dev/null >> output.log || echo "âŒ find æ²¡æ‰¾åˆ° nvcc" >> output.log

echo "ðŸ“ /usr/local å†…å®¹:" >> output.log
ls -lh /usr/local >> output.log

echo "ðŸ“ /usr/local/cuda* å†…å®¹:" >> output.log
ls -ld /usr/local/cuda* >> output.log || echo "âš ï¸ /usr/local/cuda* ä¸å­˜åœ¨" >> output.log

echo "ðŸ“¥ å°è¯•æ‰§è¡Œ nvidia-smi:" >> output.log
nvidia-smi >> output.log 2>> error.log || echo "âŒ nvidia-smi å¤±è´¥" >> output.log

# CUDA_HOME è®¾ç½®
if command -v nvcc &> /dev/null; then
    export CUDA_HOME=$(dirname $(dirname $(which nvcc)))
    echo "âœ… CUDA_HOME è‡ªåŠ¨è®¾ç½®ä¸º: $CUDA_HOME" >> output.log
elif [ -x /usr/local/cuda-11.8/bin/nvcc ]; then
    export CUDA_HOME=/usr/local/cuda-11.8
    echo "âš ï¸ fallback: CUDA_HOME è®¾ç½®ä¸º: $CUDA_HOME" >> output.log
else
    echo "âŒ CUDA_HOME è®¾ç½®å¤±è´¥ï¼ˆnvcc ä¸å­˜åœ¨ï¼‰" >> output.log
fi

echo "ðŸ“Œ PATH çŽ¯å¢ƒå˜é‡:" >> output.log
echo "$PATH" >> output.log

echo "ðŸ“Œ LD_LIBRARY_PATH:" >> output.log
echo "$LD_LIBRARY_PATH" >> output.log

echo "ðŸ“Œ CONDA ä¿¡æ¯:" >> output.log
conda info >> output.log
conda env list >> output.log

echo "ðŸ Python/PIP è·¯å¾„:" >> output.log
which python >> output.log
which pip >> output.log

echo "ðŸ Python ç‰ˆæœ¬:" >> output.log
python --version >> output.log

echo "âœ… DEBUG æ£€æŸ¥å®Œæ¯•ã€‚" >> output.log
