#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_debug
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

echo "ðŸ”§ å¼€å§‹ DEBUG æ£€æŸ¥..." >> output.log
echo "ðŸ‘¤ ç”¨æˆ·: $(whoami)" >> output.log
echo "ðŸ“¡ ä¸»æœº: $(hostname)" >> output.log
echo "ðŸ“‚ å½“å‰è·¯å¾„: $(pwd)" >> output.log
echo "ðŸ—‚ å½“å‰ç›®å½•å†…å®¹:" >> output.log
ls -alh "$SLURM_SUBMIT_DIR" >> output.log

echo "ðŸ§ª æ£€æŸ¥ module å‘½ä»¤..." >> output.log
if [ -f /etc/profile.d/modules.sh ]; then
    echo "âœ… modules.sh å­˜åœ¨ï¼Œå°è¯• source" >> output.log
    source /etc/profile.d/modules.sh || echo "âš ï¸ source modules.sh å¤±è´¥" >> output.log
else
    echo "âŒ /etc/profile.d/modules.sh ä¸å­˜åœ¨" >> output.log
fi

echo "ðŸ“¦ å½“å‰åŠ è½½çš„ modules:" >> output.log
module list 2>> error.log >> output.log

echo "ðŸ“¥ å°è¯•åŠ è½½ CUDA æ¨¡å—..." >> output.log
module purge
module load cuda/11.8 && echo "âœ… æˆåŠŸåŠ è½½ cuda/11.8" >> output.log || echo "âŒ åŠ è½½ cuda/11.8 å¤±è´¥" >> output.log

echo "ðŸ” æ£€æŸ¥ nvcc è·¯å¾„:" >> output.log
which nvcc >> output.log 2>> error.log || echo "âŒ nvcc æœªæ‰¾åˆ°" >> output.log

# ðŸ§  æ–°å¢žï¼šæ‰‹åŠ¨æŸ¥æ‰¾ nvcc è·¯å¾„å¹¶è®¾ç½® CUDA_HOME
echo "ðŸ“Œ æ‰‹åŠ¨æŸ¥æ‰¾ nvcc è·¯å¾„..." >> output.log
NVCC_PATH=$(find /vol /usr -type f -name nvcc 2>/dev/null | grep bin/nvcc | head -n 1)
if [ -n "$NVCC_PATH" ]; then
    export CUDA_HOME=$(dirname "$(dirname "$NVCC_PATH")")
    export PATH="$CUDA_HOME/bin:$PATH"
    export LD_LIBRARY_PATH="$CUDA_HOME/lib64:$LD_LIBRARY_PATH"
    echo "âœ… æ‰¾åˆ°å¹¶è®¾ç½® CUDA_HOME: $CUDA_HOME" >> output.log
else
    echo "âŒ æœªèƒ½æ‰¾åˆ° nvccï¼Œè¯·æ£€æŸ¥ CUDA æ˜¯å¦æ­£ç¡®å®‰è£…" >> output.log
fi

# è¾“å‡ºè·¯å¾„çŽ¯å¢ƒå˜é‡
echo "ðŸ“Œ PATH çŽ¯å¢ƒå˜é‡:" >> output.log
echo "$PATH" >> output.log
echo "ðŸ“Œ LD_LIBRARY_PATH:" >> output.log
echo "$LD_LIBRARY_PATH" >> output.log

# æ£€æŸ¥ nvcc å¯ç”¨æ€§
echo "ðŸ“Œ nvcc ç‰ˆæœ¬æ£€æŸ¥:" >> output.log
nvcc --version >> output.log 2>> error.log || echo "âŒ nvcc æ— æ³•æ‰§è¡Œ" >> output.log

# æ£€æŸ¥ nvidia-smi æ˜¯å¦å¯ç”¨
echo "ðŸ“¥ å°è¯•æ‰§è¡Œ nvidia-smi:" >> output.log
nvidia-smi >> output.log 2>> error.log || echo "âŒ nvidia-smi å¤±è´¥" >> output.log

# åˆ—å‡ºä¸€äº›å¸¸ç”¨ç›®å½•å†…å®¹
echo "ðŸ“ /usr/local å†…å®¹:" >> output.log
ls -lh /usr/local >> output.log

echo "ðŸ“ /vol/cuda* å†…å®¹:" >> output.log
ls -ld /vol/cuda* >> output.log 2>> error.log || echo "âš ï¸ /vol/cuda* ä¸å­˜åœ¨" >> output.log

# Conda å’Œ Python ä¿¡æ¯
echo "ðŸ“Œ CONDA ä¿¡æ¯:" >> output.log
conda info >> output.log
conda env list >> output.log

echo "ðŸ Python/PIP è·¯å¾„:" >> output.log
which python >> output.log
which pip >> output.log

echo "ðŸ Python ç‰ˆæœ¬:" >> output.log
python --version >> output.log

echo "âœ… DEBUG æ£€æŸ¥å®Œæ¯•ã€‚" >> output.log
