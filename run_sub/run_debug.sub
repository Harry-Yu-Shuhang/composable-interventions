#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_debug
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

# === Conda çŽ¯å¢ƒå¤„ç† ===
echo "ðŸ” é‡å»º conda çŽ¯å¢ƒ: lm-compose" >> output.log
source /mnt/fast/nobackup/users/ly0008/miniconda3/etc/profile.d/conda.sh
eval "$(conda shell.bash hook)"

# Debug: å½“å‰ç”¨æˆ·å’Œè·¯å¾„
echo "ðŸ‘¤ å½“å‰ç”¨æˆ·: $(whoami)" >> output.log
echo "ðŸ“‚ å½“å‰ç›®å½•å†…å®¹:" >> output.log
ls -alh "$SLURM_SUBMIT_DIR" >> output.log

# Debug: module å‘½ä»¤æ˜¯å¦å¯ç”¨
if [ -f /etc/profile.d/modules.sh ]; then
    echo "ðŸ“¦ modules.sh å­˜åœ¨ï¼Œå°è¯• source ..." >> output.log
    source /etc/profile.d/modules.sh || echo "âš ï¸ source modules.sh å¤±è´¥" >> output.log
else
    echo "âš ï¸ modules.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡ module åŠ è½½" >> output.log
fi

# å°è¯•åŠ è½½ CUDA module
module load cuda/11.8 && echo "âœ… æˆåŠŸåŠ è½½ CUDA/11.8 æ¨¡å—" >> output.log || echo "âŒ module load cuda/11.8 å¤±è´¥" >> output.log

# Debug: æ£€æŸ¥ nvcc æ˜¯å¦å­˜åœ¨
echo "ðŸ” æ£€æŸ¥ nvcc è·¯å¾„..." >> output.log
which nvcc >> output.log 2>> error.log || echo "âŒ nvcc ä¸åœ¨ PATH ä¸­" >> output.log

# Debug: æ˜¾ç¤º /usr/local ç›®å½•
echo "ðŸ“ /usr/local å†…å®¹:" >> output.log
ls -l /usr/local >> output.log

# Debug: æ˜¾ç¤º /usr/local/cuda* ç›®å½•
echo "ðŸ“ /usr/local/cuda* å†…å®¹:" >> output.log
ls -ld /usr/local/cuda* >> output.log || echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° /usr/local/cuda*" >> output.log

# Debug: å°è¯•æ‰¾åˆ° nvcc å®žé™…ä½ç½®
echo "ðŸ” æœç´¢ nvcc ..." >> output.log
find /usr/local -name nvcc 2>/dev/null >> output.log || echo "âŒ find nvcc æœªæ‰¾åˆ°" >> output.log

# === CUDA_HOME è®¾ç½®å°è¯•ï¼ˆä¿ç•™åŽŸé€»è¾‘ï¼‰===
if command -v nvcc &> /dev/null; then
    export CUDA_HOME=$(dirname $(dirname $(which nvcc)))
    echo "âœ… CUDA_HOME è‡ªåŠ¨è®¾ç½®ä¸º: $CUDA_HOME" >> output.log
elif [ -x /usr/local/cuda-11.8/bin/nvcc ]; then
    export CUDA_HOME=/usr/local/cuda-11.8
    echo "âš ï¸ fallback: CUDA_HOME è®¾ç½®ä¸º: $CUDA_HOME" >> output.log
else
    echo "âŒ æœªæ‰¾åˆ° nvccï¼Œè®¾ç½® CUDA_HOME å¤±è´¥ï¼ç»§ç»­æ‰§è¡Œï¼Œä½†å¯èƒ½åŽç»­å¤±è´¥" >> output.log
fi

# Debug: å½“å‰çŽ¯å¢ƒå˜é‡
echo "ðŸ“Œ å½“å‰ PATH:" >> output.log
echo "$PATH" >> output.log
echo "ðŸ“Œ å½“å‰ LD_LIBRARY_PATH:" >> output.log
echo "$LD_LIBRARY_PATH" >> output.log
