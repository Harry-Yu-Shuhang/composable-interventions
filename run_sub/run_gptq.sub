#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# === Conda çŽ¯å¢ƒå¤„ç†ï¼ˆå¼ºåˆ¶åˆ é™¤é‡å»ºï¼‰===
echo "ðŸ” é‡å»º conda çŽ¯å¢ƒ: lm-compose" >> output.log
source /mnt/fast/nobackup/users/ly0008/miniconda3/etc/profile.d/conda.sh

# å¦‚æžœçŽ¯å¢ƒå·²å­˜åœ¨åˆ™åˆ é™¤
if conda info --envs | grep -q "lm-compose"; then
    echo "ðŸ§¹ åˆ é™¤å·²æœ‰çŽ¯å¢ƒ 'lm-compose'..." >> output.log
    conda remove -n lm-compose --all -y >> output.log 2>> error.log
fi

# åˆ›å»ºæ–°çŽ¯å¢ƒå¹¶å®‰è£… gcc
echo "âš™ï¸ åˆ›å»º conda çŽ¯å¢ƒ 'lm-compose' å¹¶å®‰è£… gcc..." >> output.log
conda create -n lm-compose python=3.11 -y >> output.log 2>> error.log
conda activate lm-compose || { echo "âŒ æ¿€æ´»å¤±è´¥" >> output.log; exit 1; }

# å®‰è£…ç¼–è¯‘å·¥å…·é“¾
conda install -c conda-forge gcc gxx_linux-64 libstdcxx-ng cmake ninja -y >> output.log 2>> error.log

# === çŽ¯å¢ƒå˜é‡è®¾ç½® ===
export CUDA_HOME=/usr/local/cuda
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$CUDA_HOME/lib64:$LD_LIBRARY_PATH
export PATH=$CONDA_PREFIX/bin:$PATH

# æ£€æŸ¥ g++ æ˜¯å¦å¯ç”¨
echo "ðŸ” g++ è·¯å¾„: $(which g++)" >> output.log
g++ --version >> output.log 2>> error.log

# === å®‰è£… Python ä¾èµ– ===
echo "ðŸ“¦ å®‰è£… Python ä¾èµ–..." >> output.log
pip install pandas gekko numpy transformers accelerate >> output.log 2>> error.log

# === å®‰è£…é¡¹ç›®å’Œæ’ä»¶ ===
pip install -e . >> output.log 2>> error.log
pip install -e AutoGPTQ || { echo "âŒ å®‰è£… AutoGPTQ å¤±è´¥" >> output.log; exit 1; }
pip install -e AutoAWQ || { echo "âŒ å®‰è£… AutoAWQ å¤±è´¥" >> output.log; exit 1; }

# === CUDA æ‰©å±•æ£€æŸ¥ ===
python -c "from auto_gptq.utils.import_utils import is_cuda_extension_available as check; print('âœ… AutoGPTQ + CUDA Extension OK' if check() else 'âŒ CUDA Extension Missing')" >> output.log 2>> error.log

# === æ¨¡åž‹æ£€æŸ¥ ===
MODEL_DIR="models/deepseek-math-7b-instruct"
if [ ! -d "$MODEL_DIR" ]; then
    echo "âŒ æ¨¡åž‹ç›®å½•ä¸å­˜åœ¨: $MODEL_DIR" >> output.log
    echo "è¯·å…ˆè¿è¡Œï¼šhuggingface-cli download deepseek-ai/deepseek-math-7b-instruct --local-dir $MODEL_DIR --local-dir-use-symlinks False" >> output.log
    exit 1
fi

# === æ‰§è¡Œ GPTQ åŽ‹ç¼© ===
echo "ðŸ“¦ å¼€å§‹ GPTQ åŽ‹ç¼©..." >> output.log
python main.py \
    model_name=$MODEL_DIR \
    interventions=[compress] \
    compress=gptq \
    wbits=4 \
    output_dir=compressed_models/deepseek-math-7b-gptq >> output.log 2>> error.log

echo "âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ" >> output.log