#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENOï¼Œé€€å‡ºç  $?"; exit 1' ERR

echo "ğŸ” ä»»åŠ¡å¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æäº¤ç›®å½•ï¼Œé€€å‡º"; exit 1; }

# ===== Apptainer æ¨¡å— =====
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh || true
    module load apptainer || echo "âš ï¸ æ— æ³•åŠ è½½ apptainerï¼Œç¡®ä¿å·²å®‰è£…"
fi

# ===== å®¹å™¨é•œåƒæ„å»º =====
DEF_FILE="run_sub/lm-compose.def"
SIF_FILE="run_sub/lm-compose.sif"
if [ ! -f "$SIF_FILE" ]; then
    echo "ğŸ“¦ æ„å»ºå®¹å™¨é•œåƒ: $SIF_FILE"
    apptainer build "$SIF_FILE" "$DEF_FILE"
else
    echo "âœ… å®¹å™¨é•œåƒå·²å­˜åœ¨: $SIF_FILE"
fi

# ===== ä¸‹è½½æ¨¡å‹ï¼ˆå¦‚æœªå­˜åœ¨ï¼‰=====
MODEL_NAME="deepseek-ai/deepseek-math-7b-instruct"
MODEL_DIR="models/deepseek-math-7b-instruct"
TOKEN_FILE="run_sub/huggingface.token"

if [ ! -f "$TOKEN_FILE" ]; then
    echo "âŒ ç¼ºå°‘ token æ–‡ä»¶: $TOKEN_FILE"
    exit 1
fi

HF_TOKEN=$(cat "$TOKEN_FILE")

if [ ! -d "$MODEL_DIR" ]; then
    echo "ğŸ“¥ æœªæ‰¾åˆ°æ¨¡å‹ç›®å½•ï¼Œå¼€å§‹ä¸‹è½½: $MODEL_NAME"
    apptainer exec --nv --bind "$PWD":/workspace "$SIF_FILE" \
      bash -c "
        cd /workspace &&
        export HUGGINGFACE_HUB_TOKEN=$HF_TOKEN &&
        huggingface-cli download $MODEL_NAME \
          --local-dir $MODEL_DIR \
          --local-dir-use-symlinks False
      "
else
    echo "âœ… æ¨¡å‹å·²å­˜åœ¨: $MODEL_DIR"
fi

# ===== æ‰§è¡Œä¸»ç¨‹åº =====
apptainer exec --nv --bind "$PWD":/workspace "$SIF_FILE" \
  bash -c "cd /workspace && conda run -n lm-compose \
    python main.py \
      model_name=$MODEL_DIR \
      interventions=[compress] \
      compress=gptq \
      wbits=4 \
      output_dir=compressed_models/deepseek-math-7b-gptq"

echo "âœ… ä»»åŠ¡å®Œæˆ: $(date)"