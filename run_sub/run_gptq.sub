#!/bin/bash

#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# === åŠ è½½æ¨¡å—ç³»ç»Ÿå’Œ CUDA ===
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
fi

AVAILABLE_CUDA=$(module spider cuda 2>&1 | grep -Eo 'cuda/11\.8' | tail -n1)
if [[ -n "$AVAILABLE_CUDA" ]]; then
    module load "$AVAILABLE_CUDA"
    echo "âœ… åŠ è½½ CUDA: $AVAILABLE_CUDA" >> output.log
else
    echo "âš ï¸ æ‰¾ä¸åˆ° CUDA 11.8" >> output.log
fi

# === æ£€æŸ¥ GPU ===
echo "ðŸ” GPU è®¾å¤‡ä¿¡æ¯ï¼š" >> output.log
nvidia-smi >> output.log 2>> error.log || echo "âš ï¸ GPU æ£€æµ‹å¤±è´¥" >> output.log

# === Conda çŽ¯å¢ƒåˆ¤æ–­ + è‡ªåŠ¨åˆ›å»º ===
echo "ðŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ conda çŽ¯å¢ƒ: lm-compose" >> output.log
source ~/.bashrc

if conda info --envs | grep -q "lm-compose"; then
    echo "âœ… å·²å­˜åœ¨çŽ¯å¢ƒ 'lm-compose'" >> output.log
else
    echo "âš™ï¸ åˆ›å»º conda çŽ¯å¢ƒ 'lm-compose'..." >> output.log
    conda create -n lm-compose python=3.11 -y >> output.log 2>> error.log
    source activate lm-compose
    pip install -e . >> output.log 2>> error.log
    pip install -e AutoGPTQ >> output.log 2>> error.log
    pip install transformers accelerate >> output.log 2>> error.log
    echo "âœ… çŽ¯å¢ƒåˆ›å»ºå®Œæˆ" >> output.log
fi

echo "ðŸš€ æ¿€æ´» conda çŽ¯å¢ƒ" >> output.log
conda activate lm-compose || { echo "âŒ æ¿€æ´»å¤±è´¥" >> output.log; exit 1; }

# === æ£€æŸ¥æ¨¡åž‹è·¯å¾„ ===
MODEL_DIR="models/deepseek-math-7b-instruct"
if [ ! -d "$MODEL_DIR" ]; then
    echo "âŒ æ¨¡åž‹ç›®å½•ä¸å­˜åœ¨: $MODEL_DIR" >> output.log
    echo "è¯·å…ˆè¿è¡Œï¼šhuggingface-cli download deepseek-ai/deepseek-math-7b-instruct --local-dir $MODEL_DIR --local-dir-use-symlinks False" >> output.log
    exit 1
fi

# === æ‰§è¡Œ GPTQ åŽ‹ç¼© ===
echo "ðŸ“¦ å¼€å§‹ GPTQ åŽ‹ç¼©..." >> output.log
python main.py \
    model_name=$MODEL_DIR \
    interventions=[compress] \
    compress=gptq \
    wbits=4 >> output.log 2>> error.log

echo "âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ" >> output.log
