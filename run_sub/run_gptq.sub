#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

set -e

echo "ğŸ” ä»»åŠ¡å¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"

cd "$SLURM_SUBMIT_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æäº¤ç›®å½•ï¼Œé€€å‡º"; exit 1; }

# ========== åŠ è½½ Apptainer æ¨¡å—ï¼ˆå¦‚æœå¯ç”¨ï¼‰==========
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh || true
fi

# ========== å®¹å™¨æ‰§è¡Œ ==========
# lm-compose.sif æ˜¯ä½ ç”¨ .def æ„å»ºå¥½çš„å®¹å™¨é•œåƒæ–‡ä»¶
apptainer exec --nv --bind "$PWD":/workspace lm-compose.sif \
  bash -c "cd /workspace && conda run -n lm-compose \
    python main.py \
      model_name=models/deepseek-math-7b-instruct \
      interventions=[compress] \
      compress=gptq \
      wbits=4 \
      output_dir=compressed_models/deepseek-math-7b-gptq"

echo "âœ… å®Œæˆæ—¶é—´: $(date)"
