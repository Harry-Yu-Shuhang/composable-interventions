#!/bin/bash

#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# === åŠ è½½æ¨¡å—ç³»ç»Ÿå’Œ CUDA ===
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
fi

module load gcc/12.2.0         # ä¿è¯ libstdc++ >= GLIBCXX_3.4.29
module load cuda/11.8          # ä½¿ç”¨æŽ¨è CUDA ç‰ˆæœ¬
echo "âœ… åŠ è½½ CUDA å’Œ GCC" >> output.log

# === æ£€æŸ¥ GPU ===
echo "ðŸ” GPU è®¾å¤‡ä¿¡æ¯ï¼š" >> output.log
nvidia-smi >> output.log 2>> error.log || echo "âš ï¸ GPU æ£€æµ‹å¤±è´¥" >> output.log

# === Conda çŽ¯å¢ƒåˆ¤æ–­ ===
echo "ðŸ” æ£€æŸ¥ conda çŽ¯å¢ƒ: lm-compose" >> output.log
source ~/.bashrc

if ! conda info --envs | grep -q "lm-compose"; then
    echo "âš™ï¸ åˆ›å»º conda çŽ¯å¢ƒ 'lm-compose'..." >> output.log
    conda create -n lm-compose python=3.11 -y >> output.log 2>> error.log
fi

echo "ðŸš€ æ¿€æ´» conda çŽ¯å¢ƒ" >> output.log
conda activate lm-compose || { echo "âŒ æ¿€æ´»å¤±è´¥" >> output.log; exit 1; }

# === è®¾ç½®è·¯å¾„å˜é‡ï¼ˆé‡è¦ï¼‰===
export CUDA_HOME=/usr/local/cuda
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# === å®‰è£…ä¾èµ–ï¼ˆç³»ç»Ÿçº§ + pip ä¾èµ–ï¼‰===
echo "ðŸ“¦ å®‰è£…ä¾èµ–..." >> output.log
conda install -c conda-forge libstdcxx-ng gxx_linux-64 cmake ninja -y >> output.log 2>> error.log
pip install pandas gekko numpy transformers accelerate >> output.log 2>> error.log

# === å®‰è£…é¡¹ç›®å’Œæ’ä»¶ ===
pip install -e . >> output.log 2>> error.log
pip install -e AutoGPTQ >> output.log 2>> error.log
pip install -e AutoAWQ >> output.log 2>> error.log

# === æ£€æŸ¥ AutoGPTQ æ˜¯å¦åŒ…å« CUDA æ‰©å±• ===
python -c "from auto_gptq.utils.import_utils import is_cuda_extension_available as check; print('âœ… AutoGPTQ + CUDA Extension OK' if check() else 'âŒ CUDA Extension Missing')" >> output.log 2>> error.log || { echo 'âŒ AutoGPTQ å®‰è£…å¤±è´¥'; exit 1; }

# === æ£€æŸ¥æ¨¡åž‹è·¯å¾„ ===
MODEL_DIR="models/deepseek-math-7b-instruct"
if [ ! -d "$MODEL_DIR" ]; then
    echo "âŒ æ¨¡åž‹ç›®å½•ä¸å­˜åœ¨: $MODEL_DIR" >> output.log
    echo "è¯·å…ˆè¿è¡Œï¼šhuggingface-cli download deepseek-ai/deepseek-math-7b-instruct --local-dir $MODEL_DIR --local-dir-use-symlinks False" >> output.log
    exit 1
fi

# === æ‰§è¡Œ GPTQ åŽ‹ç¼© ===
echo "ðŸ“¦ å¼€å§‹ GPTQ åŽ‹ç¼©..." >> output.log
python main.py \
    model_name=$MODEL_DIR \
    interventions=[compress] \
    compress=gptq \
    wbits=4 \
    output_dir=compressed_models/deepseek-math-7b-gptq >> output.log 2>> error.log

if [ $? -eq 0 ]; then
    echo "âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ" >> output.log
else
    echo "âŒ ä»»åŠ¡æ‰§è¡Œä¸­æ–­ï¼Œè¯·æ£€æŸ¥ error.log" >> output.log
fi
