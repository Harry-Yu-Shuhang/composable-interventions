#!/bin/bash

#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

# CUDA å†…å­˜ç®¡ç†ç­–ç•¥
export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# åŠ è½½ module ç³»ç»Ÿ
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
else
    echo "âš ï¸ modules.sh æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ module æ“ä½œ" >> output.log
fi

# åŠ è½½ CUDA 11.8
AVAILABLE_CUDA=$(module spider cuda 2>&1 | grep -Eo 'cuda/11\.8' | tail -n1)
if [[ -n "$AVAILABLE_CUDA" ]]; then
    module load "$AVAILABLE_CUDA"
    echo "âœ… åŠ è½½ CUDA ç‰ˆæœ¬: $AVAILABLE_CUDA" >> output.log
else
    echo "âš ï¸ æ‰¾ä¸åˆ° CUDA 11.8ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿ CUDA" >> output.log
fi

# æ£€æŸ¥ GPU
echo "ðŸ” GPU è®¾å¤‡ä¿¡æ¯ï¼š" >> output.log
nvidia-smi >> output.log 2>> error.log || echo "âš ï¸ GPU æ£€æµ‹å¤±è´¥ï¼Œå¯èƒ½ä½¿ç”¨ CPU" >> output.log

# æ¿€æ´» uv è™šæ‹ŸçŽ¯å¢ƒ
echo "ðŸš€ æ¿€æ´» uv çŽ¯å¢ƒ" >> output.log
pip install uv >> output.log 2>> error.log || echo "âš ï¸ uv å®‰è£…å¤±è´¥" >> output.log
uv pip install "transformers>=4.38.0" "auto-gptq>=0.6.0" --upgrade >> output.log 2>> error.log
uv sync >> output.log 2>> error.log || echo "âš ï¸ uv sync å¤±è´¥" >> output.log

# === æ£€æŸ¥æ¨¡åž‹ç›®å½•æ˜¯å¦å­˜åœ¨ ===
MODEL_DIR="models/deepseek-math-7b-instruct"
if [ ! -d "$MODEL_DIR" ]; then
    echo "âŒ æ¨¡åž‹ç›®å½• $MODEL_DIR ä¸å­˜åœ¨ï¼Œè¯·å…ˆç”¨ huggingface-cli ä¸‹è½½ï¼š" >> output.log
    echo "huggingface-cli download deepseek-ai/deepseek-math-7b-instruct --local-dir $MODEL_DIR --local-dir-use-symlinks False" >> output.log
    exit 1
fi

# === æ‰§è¡Œ GPTQ åŽ‹ç¼© ===
echo "ðŸ“¦ å¼€å§‹ GPTQ åŽ‹ç¼©ä»»åŠ¡..." >> output.log
uv run python main.py \
    model_name=$MODEL_DIR \
    interventions=[compress] \
    compress=gptq \
    wbits=4 >> output.log 2>> error.log

# === å®Œæˆ ===
echo "âœ… GPTQ åŽ‹ç¼©å®Œæˆ" >> output.log