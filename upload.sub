#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=upload_qwen_hf
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --time=04:00:00
#SBATCH --output=logs/upload_model/upload_output.log
#SBATCH --error=logs/upload_model/upload_output.err

set -euo pipefail

echo "ğŸ“¦ [START] æ¨¡å‹ä¸Šä¼ ä»»åŠ¡å¯åŠ¨: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"

# ====== å‚æ•°è®¾ç½® ======
MODEL_DIR="/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/composable-interventions/models/Qwen2.5-32B-Instruct"
KEY_PATH="/vol/research/ly0008/ysh/Shuhang_Private_Key_1"
BRANCH_NAME="main"

# ====== Step 1: åˆ‡æ¢ç›®å½• ======
echo "ğŸ“ [1/5] è¿›å…¥æ¨¡å‹ç›®å½•: $MODEL_DIR"
cd "$MODEL_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æ¨¡å‹ç›®å½•"; exit 1; }

# ====== Step 2: åˆå§‹åŒ– Git ä»“åº“ï¼ˆå¦‚æœè¿˜æ²¡ initï¼‰======
if [ ! -d ".git" ]; then
    echo "ğŸ”§ [2/5] åˆå§‹åŒ– Git ä»“åº“..."
    git init
    git remote add origin git@huggingface.co:HarryYSH/Qwen2.5-32B-Instruct
else
    echo "âœ”ï¸ [2/5] Git ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
fi

# ====== Step 3: æ·»åŠ æ›´æ”¹ ======
echo "â• [3/5] æ·»åŠ æ‰€æœ‰æ–‡ä»¶..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git add .

# ====== Step 4: æäº¤æ›´æ”¹ ======
echo "ğŸ“ [4/5] æäº¤æ›´æ”¹..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git commit -m "ğŸ”§ Update config and push model" || echo "âš ï¸ æ— éœ€æäº¤ï¼Œå¯èƒ½æ— æ›´æ”¹"

# å¼ºåˆ¶ä½¿ç”¨ main åˆ†æ”¯ï¼ˆé¿å… master é”™è¯¯ï¼‰
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git branch -M "$BRANCH_NAME"

# ====== Step 5: æ¨é€åˆ° HuggingFace ======
echo "ğŸš€ [5/5] æ¨é€åˆ° HuggingFace ä»“åº“..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git push -u origin "$BRANCH_NAME"

echo "âœ… [DONE] æ¨¡å‹ä¸Šä¼ å®Œæˆ: $(date)"
