#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=upload_qwen_hf
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --time=04:00:00
#SBATCH --output=logs/upload_model/upload_output.log
#SBATCH --error=logs/upload_model/upload_output.err

set -euo pipefail

echo "ğŸ“¦ [START] æ¨¡å‹ä¸Šä¼ ä»»åŠ¡å¯åŠ¨: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"

# ====== å‚æ•°è®¾ç½® ======
MODEL_DIR="/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/composable-interventions/models/Qwen2.5-32B-Instruct"
KEY_PATH="/vol/research/ly0008/ysh/Shuhang_Private_Key_1"
BRANCH_NAME="main"

# ====== Step 1: åˆ‡æ¢ç›®å½• ======
echo "ğŸ“ [1/6] è¿›å…¥æ¨¡å‹ç›®å½•: $MODEL_DIR"
cd "$MODEL_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æ¨¡å‹ç›®å½•"; exit 1; }

# ====== Step 2: åˆå§‹åŒ– Git ä»“åº“ï¼ˆå¦‚æœªåˆå§‹åŒ–ï¼‰ ======
if [ ! -d ".git" ]; then
    echo "ğŸ”§ [2/6] åˆå§‹åŒ– Git ä»“åº“..."
    git init
    git remote add origin git@huggingface.co:HarryYSH/Qwen2.5-32B-Instruct
else
    echo "âœ”ï¸ [2/6] Git ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
fi

# ====== Step 3: åˆå§‹åŒ– Git LFS å¹¶è·Ÿè¸ªå¤§æ¨¡å‹æ–‡ä»¶ ======
echo "ğŸ“¦ [3/6] åˆå§‹åŒ– Git LFS..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git lfs install
echo "*.safetensors filter=lfs diff=lfs merge=lfs -text" > .gitattributes
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git add .gitattributes

# ====== Step 4: æ·»åŠ å…ƒæ•°æ®æ–‡ä»¶ ======
echo "ğŸ—‚ï¸ [4/6] æ·»åŠ å…ƒæ•°æ®æ–‡ä»¶..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git add \
    config.json tokenizer.json tokenizer_config.json merges.txt \
    vocab.json generation_config.json README.md LICENSE \
    model.safetensors.index.json

GIT_SSH_COMMAND="ssh -i $KEY_PATH" git commit -m "ğŸ§¾ Add model config and metadata" || echo "âš ï¸ æ— éœ€æäº¤ config"

# ====== Step 5: æ·»åŠ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼ˆå¯èƒ½è¾ƒæ…¢ï¼‰======
echo "ğŸ“¦ [5/6] æ·»åŠ æ¨¡å‹å‚æ•°æ–‡ä»¶ï¼ˆ.safetensorsï¼‰..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git add *.safetensors

GIT_SSH_COMMAND="ssh -i $KEY_PATH" git commit -m "ğŸ“¦ Upload model weights via Git LFS" || echo "âš ï¸ æ— éœ€æäº¤æƒé‡"

# å¼ºåˆ¶ä½¿ç”¨ main åˆ†æ”¯ï¼ˆé¿å… master é”™è¯¯ï¼‰
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git branch -M "$BRANCH_NAME"

# ====== Step 6: æ¨é€åˆ° HuggingFace ======
echo "ğŸš€ [6/6] æ¨é€åˆ° HuggingFace ä»“åº“..."
GIT_SSH_COMMAND="ssh -i $KEY_PATH" git push -u origin "$BRANCH_NAME"

echo "âœ… [DONE] æ¨¡å‹ä¸Šä¼ å®Œæˆ: $(date)"
