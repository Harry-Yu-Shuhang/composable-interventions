#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=upload_qwen_hf
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --time=04:00:00
#SBATCH --output=logs/upload_model/upload_output.log
#SBATCH --error=logs/upload_model/upload_output.err

set -euo pipefail

echo "ğŸ“¦ [START] æ¨¡å‹ä¸Šä¼ ä»»åŠ¡å¯åŠ¨: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"

# ====== å‚æ•°è®¾ç½® ======
MODEL_DIR="/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/composable-interventions/models/Qwen2.5-32B-Instruct"
HF_USERNAME="HarryYSH"
REPO_NAME="Qwen2.5-32B-Instruct"
BRANCH_NAME="main"

# æ£€æŸ¥ token æ˜¯å¦è®¾ç½®
if [[ -z "${HF_TOKEN:-}" ]]; then
  echo "âŒ ç¯å¢ƒå˜é‡ HF_TOKEN æœªè®¾ç½®ï¼Œè¯· export HF_TOKEN=xxx åå†æäº¤ä»»åŠ¡"
  exit 1
fi

# ====== Step 1: è¿›å…¥æ¨¡å‹ç›®å½• ======
echo "ğŸ“ [1/6] è¿›å…¥æ¨¡å‹ç›®å½•: $MODEL_DIR"
cd "$MODEL_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æ¨¡å‹ç›®å½•"; exit 1; }

# ====== Step 2: åˆå§‹åŒ– Git ä»“åº“ ======
if [ ! -d ".git" ]; then
    echo "ğŸ”§ [2/6] åˆå§‹åŒ– Git ä»“åº“..."
    git init
    git remote add origin https://huggingface.co/${HF_USERNAME}/${REPO_NAME}
else
    echo "âœ”ï¸ [2/6] Git ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
fi

# ====== Step 3: åˆå§‹åŒ– Git LFS ======
if ! git lfs ls-files | grep -q safetensors; then
    echo "ğŸ“¦ [3/6] åˆå§‹åŒ– Git LFS..."
    git lfs install
    echo "*.safetensors filter=lfs diff=lfs merge=lfs -text" > .gitattributes
    git add .gitattributes
fi

# ====== Step 4: æ·»åŠ å…ƒæ•°æ®æ–‡ä»¶ ======
echo "ğŸ—‚ï¸ [4/6] æ·»åŠ å…ƒæ•°æ®æ–‡ä»¶..."
git add config.json tokenizer.json tokenizer_config.json merges.txt \
        vocab.json generation_config.json README.md LICENSE \
        model.safetensors.index.json || true

git commit -m "ğŸ§¾ Add model config and metadata" || echo "âš ï¸ æ— éœ€æäº¤ config"

# ====== Step 5: æ·»åŠ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼ˆ.safetensorsï¼‰======
echo "ğŸ“¦ [5/6] æ·»åŠ æ¨¡å‹å‚æ•°æ–‡ä»¶ï¼ˆ.safetensorsï¼‰..."
git add *.safetensors || true
git commit -m "ğŸ“¦ Upload model weights via Git LFS" || echo "âš ï¸ æ— éœ€æäº¤æƒé‡"

git branch -M "$BRANCH_NAME"

# ====== Step 6: æ¨é€åˆ° HuggingFace ======
echo "ğŸš€ [6/6] æ¨é€åˆ° HuggingFace ä»“åº“..."
# è®¾ç½® HTTPS å‡­è¯ï¼ˆå†™å…¥åˆ° .netrcï¼‰
echo -e "machine huggingface.co\nlogin ${HF_USERNAME}\npassword ${HF_TOKEN}" > ~/.netrc
chmod 600 ~/.netrc

git push -u origin "$BRANCH_NAME"

echo "âœ… [DONE] æ¨¡å‹ä¸Šä¼ å®Œæˆ: $(date)"
