#!/bin/bash
#SBATCH --partition=a100
#SBATCH --nodelist=aisurrey23
#SBATCH --job-name=lmcompose-gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=128G
#SBATCH --output=logs/gptq_deepseek/output.log
#SBATCH --error=logs/gptq_deepseek/error.log

set -euo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENOï¼Œé€€å‡ºç  $?"; exit 1' ERR

echo "ğŸ” ä»»åŠ¡å¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"

cd "$SLURM_SUBMIT_DIR"

# === é…ç½® Conda ç¯å¢ƒ ===
eval "$(conda shell.bash hook)"
conda activate lm-compose

# === å®‰è£… CUDAï¼ˆæ—  sudoï¼‰===
export CUDA_HOME=$HOME/cuda-11.8
export PATH="$CUDA_HOME/bin:$PATH"
export LD_LIBRARY_PATH="$CUDA_HOME/lib64:$LD_LIBRARY_PATH"

# å¯é€‰ï¼šé¦–æ¬¡è¿è¡Œæ—¶ä¸‹è½½ CUDA Toolkitï¼ˆå¦‚æœæœªè§£å‹å®Œæˆï¼‰
# wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
# chmod +x cuda_11.8.0_520.61.05_linux.run
# ./cuda_11.8.0_520.61.05_linux.run --toolkit --silent --override --installpath=$HOME/cuda-11.8

# === ç¼–è¯‘ AutoGPTQï¼ˆä½¿ç”¨ nvccï¼‰===
cd AutoGPTQ
pip install -e . || echo "âŒ AutoGPTQ å®‰è£…å¤±è´¥"
cd ..

# === æ‰§è¡Œå‹ç¼©ä»»åŠ¡ ===
python main.py \
    model_name=models/deepseek-math-7b-instruct \
    interventions=[compress] \
    compress=gptq \
    wbits=4 \
    output_dir=compressed_models/deepseek-math-7b-gptq

echo "âœ… ä»»åŠ¡å®Œæˆ: $(date)"
