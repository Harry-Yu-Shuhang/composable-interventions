#!/bin/bash
#SBATCH --partition=3090_risk
#SBATCH --nodelist=aisurrey15
#SBATCH --job-name=gptq_deepseek
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=12:00:00
#SBATCH --mem=64G
#SBATCH --output=output.log
#SBATCH --error=error.log

set -eEuo pipefail
trap 'echo "❌ 任务失败: 行号 $LINENO，退出码 $?"; exit 1' ERR

echo "🔍 任务开始: $(date)"
echo "📂 当前目录: $(pwd)"
cd "$SLURM_SUBMIT_DIR" || { echo "❌ 无法进入提交目录，退出"; exit 1; }

if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh || true
    module load apptainer || echo "⚠️ 无法加载 apptainer，确保已安装"
fi

DEF_FILE="build_apptainer/lm-compose.def"
SIF_FILE="build_apptainer/lm-compose.sif"
echo "📦 正在重新构建容器镜像: $SIF_FILE"
apptainer build --force "$SIF_FILE" "$DEF_FILE"

MODEL_DIR="/opt/app/models/deepseek-math-7b-instruct"
OUTPUT_DIR="/opt/app/compressed_models/deepseek-math-7b-gptq"

apptainer exec --nv "$SIF_FILE" \
  python /opt/app/main.py \
    model_name=$MODEL_DIR \
    interventions=[compress] \
    compress=gptq \
    wbits=4 \
    output_dir=$OUTPUT_DIR

echo "✅ 任务完成: $(date)"
